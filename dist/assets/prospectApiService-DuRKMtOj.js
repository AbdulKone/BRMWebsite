var w=Object.defineProperty;var T=(g,e,t)=>e in g?w(g,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):g[e]=t;var u=(g,e,t)=>T(g,typeof e!="symbol"?e+"":e,t);import{s as v,b as I}from"./index-DN8h3Y9b.js";import"./react-vendor-VkFUI6JC.js";import"./ui-vendor-jY-liuQK.js";class E{constructor(){u(this,"cache",new Map);u(this,"STORAGE_KEY","hunter_cache_v2");u(this,"STATS_KEY","hunter_cache_stats");u(this,"stats");this.stats={totalRequests:0,cacheHits:0,cacheMisses:0,apiCallsSaved:0},this.loadFromLocalStorage(),this.loadStats(),setInterval(()=>this.cleanup(),3600*1e3)}generateKey(e,t){const s=this.normalizeParams(t);return`hunter_${e}_${JSON.stringify(s)}`}normalizeParams(e){const t={...e};return delete t.timestamp,delete t.requestId,Object.keys(t).sort().reduce((s,a)=>(s[a]=t[a],s),{})}set(e,t,s){this.cache.set(e,{data:t,timestamp:Date.now(),ttl:s,requestCount:1}),this.saveToLocalStorage()}get(e){this.stats.totalRequests++;const t=this.cache.get(e);return t?Date.now()-t.timestamp>t.ttl?(this.cache.delete(e),this.stats.cacheMisses++,this.saveToLocalStorage(),this.saveStats(),null):(t.requestCount++,this.stats.cacheHits++,this.stats.apiCallsSaved++,this.saveStats(),t.data):(this.stats.cacheMisses++,this.saveStats(),null)}getStats(){return{...this.stats}}saveStats(){try{localStorage.setItem(this.STATS_KEY,JSON.stringify(this.stats))}catch(e){console.warn("Impossible de sauvegarder les statistiques:",e)}}loadStats(){try{const e=localStorage.getItem(this.STATS_KEY);e&&(this.stats={...this.stats,...JSON.parse(e)})}catch(e){console.warn("Impossible de charger les statistiques:",e)}}clear(){this.cache.clear(),this.saveToLocalStorage()}saveToLocalStorage(){try{const e=Array.from(this.cache.entries());localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(e){console.warn("Impossible de sauvegarder le cache:",e)}}loadFromLocalStorage(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(e){const t=JSON.parse(e);this.cache=new Map(t)}}catch(e){console.warn("Impossible de charger le cache:",e),this.cache=new Map}}cleanup(){const e=Date.now();for(const[t,s]of this.cache.entries())e-s.timestamp>s.ttl&&this.cache.delete(t);this.saveToLocalStorage()}}const h=new E;class _{constructor(){u(this,"DAILY_LIMIT",5);u(this,"MONTHLY_LIMIT",25);u(this,"WARNING_THRESHOLD",.7);u(this,"CRITICAL_THRESHOLD",.9);u(this,"STORAGE_KEY","hunter_usage_monitor");u(this,"usage",new Map);this.loadUsage(),this.cleanupOldData()}getTodayKey(){return new Date().toISOString().split("T")[0]}getMonthKey(){const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}`}getTodayUsage(){const e=this.getTodayKey();return this.usage.get(e)||{date:e,requests:0,cached:0,domains:new Set,companies:new Set}}getMonthlyUsage(){const e=this.getMonthKey();let t=0;for(const[s,a]of this.usage.entries())s.startsWith(e)&&(t+=a.requests);return t}incrementUsage(e,t,s){const a=this.getTodayKey(),r=this.getTodayUsage();e==="api"?(r.requests++,t&&r.domains.add(t),s&&r.companies.add(s)):r.cached++,this.usage.set(a,r),this.saveUsage(),this.checkAlerts()}canMakeRequest(){return this.getTodayUsage().requests<this.DAILY_LIMIT}getRemainingQuota(){const e=this.getTodayUsage(),t=this.getMonthlyUsage();return{daily:Math.max(0,this.DAILY_LIMIT-e.requests),monthly:Math.max(0,this.MONTHLY_LIMIT-t)}}getUsagePercentage(){const e=this.getTodayUsage(),t=this.getMonthlyUsage();return{daily:e.requests/this.DAILY_LIMIT*100,monthly:t/this.MONTHLY_LIMIT*100}}checkAlerts(){const e=[],t=this.getUsagePercentage(),s=this.getRemainingQuota();return t.daily>=this.CRITICAL_THRESHOLD*100?e.push({type:"critical",message:`âš ï¸ Quota quotidien critique: ${s.daily} appels restants`,percentage:t.daily}):t.daily>=this.WARNING_THRESHOLD*100&&e.push({type:"warning",message:`âš¡ Attention: ${s.daily} appels restants aujourd'hui`,percentage:t.daily}),t.monthly>=this.WARNING_THRESHOLD*100&&e.push({type:"warning",message:`ðŸ“Š Quota mensuel: ${s.monthly} appels restants`,percentage:t.monthly}),e.forEach(a=>{a.type==="critical"?console.error(a.message):console.warn(a.message)}),e}getEfficiencyStats(){const e=this.getTodayUsage(),t=e.requests+e.cached;return{cacheHitRate:t>0?e.cached/t*100:0,apiCallsSaved:e.cached,totalRequests:t}}saveUsage(){try{const e=Array.from(this.usage.entries()).map(([t,s])=>[t,{...s,domains:Array.from(s.domains),companies:Array.from(s.companies)}]);localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(e){console.warn("Erreur sauvegarde usage monitor:",e)}}loadUsage(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(e){const t=JSON.parse(e);this.usage=new Map(t.map(([s,a])=>[s,{...a,domains:new Set(a.domains||[]),companies:new Set(a.companies||[])}]))}}catch(e){console.warn("Erreur chargement usage monitor:",e),this.usage.clear()}}cleanupOldData(){const e=new Date;e.setDate(e.getDate()-30);const t=e.toISOString().split("T")[0];let s=0;for(const[a]of this.usage.entries())a<t&&(this.usage.delete(a),s++);s>0&&(console.log(`ðŸ§¹ DonnÃ©es d'usage nettoyÃ©es: ${s} jours supprimÃ©s`),this.saveUsage())}reset(){this.usage.clear(),localStorage.removeItem(this.STORAGE_KEY)}}const c=new _;class p{static async initialize(){this.initialized||(await this.loadProviders(),this.initialized=!0)}static async loadProviders(){try{const{data:e,error:t}=await v.from("api_providers").select("*").eq("active",!0);if(t)throw t;if(!e||e.length===0)throw new Error("Aucun provider API configurÃ© dans la base de donnÃ©es");this.providers=e}catch(e){throw console.error("Erreur lors du chargement des providers:",e),new Error("Impossible de charger les providers API depuis la base de donnÃ©es")}}static async fetchProspects(e){if(await this.initialize(),!c.canMakeRequest()){const r=c.getRemainingQuota();throw new Error(`Quota quotidien atteint. Restant: ${r.daily} appels`)}const t=[],{handleError:s}=I.getState(),a=this.providers.slice(0,1);for(const r of a)try{const i=await this.callProvider(r,e),n=await this.validateProspects(i);if(t.push(...n),t.length>=(e.limit||25))break}catch(i){const n=i instanceof Error?i.message:"Erreur inconnue";s(`Erreur API ${r.name}`,n);continue}return this.deduplicateProspects(t.slice(0,e.limit||25))}static async validateProspects(e){return e.filter(t=>t.email&&t.email.includes("@")&&t.confidence>=60&&t.email.length>5).map(t=>({...t,score:this.calculateScore(t),validated_at:new Date().toISOString()})).sort((t,s)=>(s.score||0)-(t.score||0))}static calculateScore(e){let t=e.confidence||50;return e.first_name&&e.last_name&&(t+=10),e.position&&(t+=15),e.linkedin&&(t+=10),e.department&&(t+=5),e.sources&&e.sources>1&&(t+=e.sources*2),Math.min(100,t)}static deduplicateProspects(e){const t=new Set;return e.filter(s=>{var r;const a=`${s.email.toLowerCase()}_${((r=s.company)==null?void 0:r.toLowerCase())||""}`;return t.has(a)?!1:(t.add(a),!0)})}static async callProvider(e,t){return e.name==="Hunter.io"?await this.callHunterApi(t):[]}static async callHunterApi(e){const t=[];if(e.domains&&e.domains.length>0)for(const a of e.domains.slice(0,3)){const r=await this.searchHunterByDomain(a);if(t.push(...r),t.length>=15)break}if(e.companyName&&t.length<10){const a=await this.searchHunterByCompany(e.companyName);t.push(...a)}if(e.keywords&&e.keywords.length>0&&t.length<15){const a=await this.searchHunterByDynamicCriteria(e);t.push(...a)}if(e.naturalLanguageQuery&&t.length<10){const a=await this.searchHunterByNaturalLanguage(e.naturalLanguageQuery);t.push(...a)}if(t.length<50){const a=await this.searchHunterByDomain(domain);t.push(...a.slice(0,50-t.length))}return t.slice(0,50)}static async searchHunterByDomain(e){var a;const t=h.generateKey("domain-search",{domain:e}),s=h.get(t);if(s)return c.incrementUsage("cache",e),s;if(!c.canMakeRequest())return console.warn("âš ï¸ Quota quotidien atteint, utilisation du cache uniquement"),[];try{const r=await fetch("/api/hunter-proxy",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({domain:e,action:"domain-search",limit:5})}),i=await r.json();if(!r.ok)throw new Error(i.error||"Erreur API Hunter.io");const n=(((a=i.data)==null?void 0:a.emails)||[]).map(o=>{var d,l;return{email:o.value,first_name:o.first_name,last_name:o.last_name,position:o.position,company:((d=i.data)==null?void 0:d.organization)||e,confidence:o.confidence,sources:((l=o.sources)==null?void 0:l.length)||0,department:o.department,seniority:o.seniority,linkedin:o.linkedin}});return h.set(t,n,1440*60*1e3),c.incrementUsage("api",e),console.log(`âœ… API Hunter.io: ${n.length} prospects trouvÃ©s pour ${e}`),n}catch(r){return console.error(`Erreur recherche domaine ${e}:`,r),[]}}static async searchHunterByCompany(e){var a;const t=h.generateKey("company-search",{companyName:e}),s=h.get(t);if(s)return c.incrementUsage("cache",void 0,e),s;if(!c.canMakeRequest())return console.warn("âš ï¸ Quota quotidien atteint, utilisation du cache uniquement"),[];try{const r=await fetch("/api/hunter-proxy",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"discover",query:`company name: ${e}`,limit:3})}),i=await r.json();if(!r.ok)throw new Error(i.error||"Erreur API Hunter.io Discover");const n=[];if((a=i.data)!=null&&a.companies){for(const o of i.data.companies.slice(0,2))if(o.domain){const d=await this.searchHunterByDomain(o.domain);n.push(...d.map(l=>({...l,company:o.name||e,industry:o.industry,company_size:o.size})))}}return h.set(t,n,1440*60*1e3),c.incrementUsage("api",void 0,e),console.log(`âœ… API Hunter.io: ${n.length} prospects trouvÃ©s pour ${e}`),n}catch(r){return console.error(`Erreur recherche entreprise ${e}:`,r),[]}}static async searchHunterByDynamicCriteria(e){var a,r,i;const t=h.generateKey("dynamic-search",e),s=h.get(t);if(s)return c.incrementUsage("cache"),s;if(!c.canMakeRequest())return console.warn("âš ï¸ Quota quotidien atteint, utilisation du cache uniquement"),[];try{const n=[];e.keywords&&e.keywords.length>0&&n.push(`keywords: ${e.keywords.slice(0,2).join(" ")}`),(a=e.quickFilters)!=null&&a.industry&&n.push(`industry: ${e.quickFilters.industry}`),(r=e.quickFilters)!=null&&r.location&&n.push(`location: ${e.quickFilters.location}`);const o=n.join(" AND ");if(!o)return[];const d=await fetch("/api/hunter-proxy",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"discover",query:o,limit:10})}),l=await d.json();if(!d.ok)throw new Error(l.error||"Erreur API Hunter.io Discover");const y=[];if((i=l.data)!=null&&i.companies){for(const m of l.data.companies.slice(0,2))if(m.domain){const f=await this.searchHunterByDomain(m.domain);y.push(...f.map(S=>({...S,company:m.name,industry:m.industry,company_size:m.size,match_criteria:o})))}}return h.set(t,y,720*60*1e3),c.incrementUsage("api"),console.log(`âœ… API Hunter.io: ${y.length} prospects trouvÃ©s pour critÃ¨res dynamiques`),y}catch(n){return console.error("Erreur recherche critÃ¨res dynamiques:",n),[]}}static async searchHunterByNaturalLanguage(e){var a;const t=h.generateKey("natural-language",{query:e}),s=h.get(t);if(s)return c.incrementUsage("cache"),s;if(!c.canMakeRequest())return console.warn("âš ï¸ Quota quotidien atteint, utilisation du cache uniquement"),[];try{const r=await fetch("/api/hunter-proxy",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"discover",query:e,limit:2})}),i=await r.json();if(!r.ok)throw new Error(i.error||"Erreur API Hunter.io Discover");const n=[];if((a=i.data)!=null&&a.companies){for(const o of i.data.companies.slice(0,1))if(o.domain){const d=await this.searchHunterByDomain(o.domain);n.push(...d.map(l=>({...l,company:o.name,industry:o.industry,natural_query:e})))}}return h.set(t,n,360*60*1e3),c.incrementUsage("api"),console.log(`âœ… API Hunter.io: ${n.length} prospects trouvÃ©s pour requÃªte naturelle`),n}catch(r){return console.error("Erreur recherche langage naturel:",r),[]}}static getUsageStats(){return{cache:h.getStats(),usage:c.getEfficiencyStats(),quota:c.getRemainingQuota()}}static clearCache(){h.clear(),console.log("ðŸ§¹ Cache Hunter.io vidÃ©")}}u(p,"providers",[]),u(p,"initialized",!1);export{p as ProspectApiService};
//# sourceMappingURL=prospectApiService-DuRKMtOj.js.map
